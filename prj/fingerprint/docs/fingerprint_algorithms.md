# Алгоритмы функционирования фингерпринтов

## Эталонный и архивный фингерпринты



1) У каждого логина есть от 0 до N побывавшими эталонными фингерпринтов, подтвержденных PIN кодом.
2) Последний побывавший эталонным фингерпринт называем эталонный фингерпринт
3) Не последние побывавшие эталонными фингерпринты называем архивными фингерпринтами
5) Ручка /fingerprint/check/pin работает только с эталонным фингерпринтом. Если текущий фингерпринт не совпадает на 90% с эталонным фингерпринтом, то ручка говорит, что нужен PIN код
6) Оплата. Так как между проверкой текущего фингерпринта в ручке /fingerprint/check/pin и оплатой может произойти событие "установка логину нового эталонного фингерпринта" или "эталонный фингерпринт протух", то оплата без PIN кода будет произведена без запроса PIN кода, если текущий фингерпринт на 100% совпадает с любым архивным фингерпринтом или на 90% с эталонным фингерпринтом.
7) Если во время оплаты был передан валидный PIN код, то текущий фингерпринт становится эталонным фингерпринтом.
8) Если во время оплаты передан архивный фингерпринт и валидный PIN код, то архивный фингерпринт становится эталонным фингерпринтом (это условие является частным случаем [7])

### TTL - время жизни эталонного фингерпринта

С моей точки зрения - это какая-то упячка - ограничивать время жизни эталонного фингерпринта. Ну да ладно.

TTL выставляется параметром etalon_fingerprint_lifetime в конфиге module/DFP (по-умолчанию равен 30 суток, т.е. 2592000 сек

Если время жизни эталонного фингерпринта превышает TTL, то он становится архивным.
Следовательно ручка /fingerprint/check/pin требует ввода PIN кода, а старт оплаты и сама оплата возможны без ввода PIN кода.

Это еще одна из причин, почему оплачивать нужно без PIN кода и на основе архивных фингерпринтов: потому, что /fingerprint/check/pin скажет, что PIN кода не нужно, а когда стартует оплата эталонный фингерпринт может протухнуть. И тем более он протухнет, когда дело дойдет до FSM.